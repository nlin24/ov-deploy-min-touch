---
- hosts: localhost
  any_errors_fatal: true
  vars:
    server_profile_template: GSE-SPT
    server_name: VMHESX101
    os_deployment_plan: ESxi 6.7-2
    ip_address: 10.188.247.23
    domainName: synergy.local
    dns1: 10.188.0.2
    dns2: 10.188.0.3
    gateway: 10.188.247.1
    netmask: 255.255.255.0
    connectionid: 1
    serverhardware: MXQ71906VL, bay 1
    esxi_password: HP!nvent123
    vcenter_hostname: 10.188.29.15
    vcenter_username: Administrator@vsphere.local
    vcenter_password: HP!nvent123
    datacenter_name: GSE-Houston
    network_set_name: GSE-NS
    cluster_name: GSE-Cluster
    vcenter_switch_name: GSE-DSWITCH
    index: 1
    vlanid: 188
    vmnic: vmnic1
    ov_hostname: "10.188.0.170"
    ov_username: "v247usradmin"
    ov_password: "HP!nvent123"
    ov_api_version: 800
  tasks:
  - name: Get network URL from connection ID
    oneview_network_set_facts:
      hostname: "{{ ov_hostname }}"
      username: "{{ ov_username }}"
      password: "{{ ov_password }}"
      api_version: "{{ ov_api_version}}"
      name: "{{ network_set_name }}"
    delegate_to: localhost
    register: network_info
  - name: Create server from server profile template with OS deployment for ESXi
    oneview_server_profile:
      hostname: "{{ ov_hostname }}"
      username: "{{ ov_username }}"
      password: "{{ ov_password }}"
      api_version: "{{ ov_api_version}}"
      data:
        name: "{{ server_name }}"
        serverProfileTemplateName: "{{ server_profile_template }}"
        serverHardwareName: "{{ serverhardware }}"
        osDeploymentSettings:
          osDeploymentPlanName: "{{ os_deployment_plan }}"
          osCustomAttributes:
            - name: Hostname
              value: "{{ server_name }}"
            - name: DomainName
              value: "{{domainName}}"
            - name: ManagementNIC.connectionid
              value: "{{ connectionid }}"
            - name: ManagementNIC.NetworkUri
              value: "{{ network_info['ansible_facts']['network_sets'][0]['networkUris'][index|int] }}"
            - name: SSH
              value: enabled
            - name: Password
              value: "{{ esxi_password }}"
            - name: ManagementNIC.dns1
              value: "{{ dns1 }}"
            - name: ManagementNIC.dns2
              value: "{{ dns2 }}"
            - name: ManagementNIC.gateway
              value: "{{ gateway }}"
            - name: ManagementNIC.ipaddress
              value: "{{ ip_address}}"  
            - name: ManagementNIC.dhcp
              value: false
            - name: ManagementNIC.netmask
              value: "{{ netmask }}"
            - name: ManagementNIC.constraint
              value: userspecified
            - name: ManagementNIC.ipv4disable
              value: false
            - name: ManagementNIC.vlanid
              value: "{{ vlanid }}"
      params: # Supported only in API version >= 600
        force: True
    delegate_to: localhost
  - name: Power on the ESXi server
    oneview_server_hardware:
      hostname: "{{ ov_hostname }}"
      username: "{{ ov_username }}"
      password: "{{ ov_password }}"
      api_version: "{{ ov_api_version}}"
      state: power_state_set
      data:
        name : "{{ serverhardware }}"
        powerStateData:
          powerState: "On"
          powerControl: "MomentaryPress"
    delegate_to: localhost
  - name: Wait for the ESXi host to respond
    wait_for: 
      delay: 120
      sleep: 3
      host: "{{ ip_address }}"
      timeout: 360
    delegate_to: localhost
  - name: Add the ESXi host to vCenter
    vmware_host:
      hostname: "{{ vcenter_hostname }}"
      username: "{{ vcenter_username }}"
      password: "{{ vcenter_password }}"
      datacenter_name: "{{ datacenter_name }}"
      cluster_name: "{{ cluster_name }}"
      esxi_hostname: "{{ ip_address }}"
      esxi_username: "root"
      esxi_password: "{{ esxi_password }}"
      state: present
      validate_certs: False
    delegate_to: localhost
  - name: Add the ESXi host to VDS
    vmware_dvs_host:
      hostname: "{{ vcenter_hostname }}"
      username: "{{ vcenter_username }}"
      password: "{{ vcenter_password }}"
      esxi_hostname: "{{ ip_address }}"
      switch_name: "{{ vcenter_switch_name }}"
      vmnics:
          - "{{ vmnic }}"
      state: present
      validate_certs: False
    delegate_to: localhost
